<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crispy Call Center System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #dc2626; /* Crispy Red */
            --primary-dark: #991b1b;
            --gold: #fbbf24;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
        
        body { background-color: var(--bg); color: var(--text); min-height: 100vh; }

        /* --- Components --- */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; transition: 0.2s; display: inline-flex; align-items: center; gap: 6px; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--secondary); }

        .card { background: var(--surface); border-radius: 10px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .input-group { margin-bottom: 12px; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; font-weight: 500; }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.95rem;
        }

        .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .badge-pending { background: #fff7ed; color: #c2410c; }
        .badge-done { background: #f0fdf4; color: #15803d; }
        .badge-task { background: #eff6ff; color: #1e40af; }

        /* Date Display */
        .date-display { background: #1e293b; color: #fff; padding: 8px 20px; border-radius: 20px; font-family: 'Courier New', monospace; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; }

        /* Trophy Card */
        .trophy-card { background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border: 2px solid var(--gold); text-align: center; position: relative; overflow: hidden; }
        .trophy-icon { font-size: 2.5rem; margin-bottom: 5px; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }

        /* --- Layouts --- */
        #auth-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #0f172a; }
        .login-box { width: 100%; max-width: 380px; }

        #app-layout { display: none; min-height: 100vh; }
        header { background: var(--surface); padding: 10px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 50; }
        .main-content { padding: 20px; max-width: 1400px; margin: 0 auto; }

        /* Tabs */
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; border-bottom: 1px solid var(--border); }
        .tab-btn { background: none; border: none; padding: 8px 16px; cursor: pointer; border-radius: 6px; font-weight: 500; color: var(--secondary); white-space: nowrap; }
        .tab-btn:hover { background: #f8fafc; }
        .tab-btn.active { background: #fee2e2; color: var(--primary); }

        /* Tables (LTR Adjustments) */
        .table-container { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 10px 15px; text-align: left; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        th { background: #f8fafc; color: var(--secondary); }
        
        .rank-1 { border-left: 4px solid var(--gold); background: #fffbeb; }
        .rank-2 { border-left: 4px solid var(--silver); background: #f8fafc; }
        .rank-3 { border-left: 4px solid var(--bronze); background: #fff7ed; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card h3 { font-size: 1.8rem; color: var(--primary); margin: 5px 0; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 200; }
        .modal-content { background: var(--surface); padding: 25px; border-radius: 10px; width: 100%; max-width: 500px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- AUTH SCREEN -->
    <section id="auth-screen">
        <div class="card login-box">
            <h2 style="text-align: center; margin-bottom: 20px; color: var(--primary);">Crispy Call Center</h2>
            <div class="input-group"><input type="email" id="login-email" placeholder="Email (admin@sys.com / agent@sys.com)"></div>
            <div class="input-group"><input type="password" id="login-password" placeholder="Password (123456)"></div>
            <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="app.login()">Login</button>
        </div>
    </section>

    <!-- APP LAYOUT -->
    <section id="app-layout">
        <header>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="width: 32px; height: 32px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">C</div>
                <span id="header-role" style="font-weight: bold; font-size: 1.1rem;">Dashboard</span>
            </div>
            
            <!-- Date Display (English) -->
            <div class="date-display">
                <span id="current-date">...</span>
            </div>

            <div style="display: flex; align-items: center; gap: 15px;">
                <span id="user-info" style="font-size: 0.9rem; color: var(--secondary);"></span>
                <button class="btn btn-outline" onclick="app.logout()">Logout</button>
            </div>
        </header>

        <main class="main-content">
            
            <!-- MANAGER VIEW -->
            <div id="manager-view" class="hidden">
                <div class="dashboard-grid">
                    <div class="card stat-card"><p>Total Orders</p><h3 id="stat-orders">0</h3></div>
                    <div class="card stat-card"><p>Complaints</p><h3 id="stat-complaints">0</h3></div>
                    <div class="card stat-card"><p>Assigned Tasks</p><h3 id="stat-tasks">0</h3></div>
                    <div class="card stat-card"><p>Active Agents</p><h3 id="stat-agents">0</h3></div>
                </div>

                <div class="tabs">
                    <button class="tab-btn active" onclick="app.switchTab('orders')">üì¶ Orders</button>
                    <button class="tab-btn" onclick="app.switchTab('direct-tasks')">üìù Assign Tasks</button>
                    <button class="tab-btn" onclick="app.switchTab('complaints')">‚ö†Ô∏è Complaints</button>
                    <button class="tab-btn" onclick="app.switchTab('leaderboard')">üèÜ Leaderboard</button>
                    <button class="tab-btn" onclick="app.switchTab('system-settings')">‚öôÔ∏è Settings</button>
                </div>

                <!-- Directed Tasks Tab -->
                <div id="tab-direct-tasks" class="tab-content hidden">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3>Call Center Tasks</h3>
                        <button class="btn btn-primary" onclick="app.openModal('add-task')">+ New Assignment</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Task</th>
                                    <th>Agent</th>
                                    <th>Category</th>
                                    <th>Time</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="tasks-table"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Orders Tab -->
                <div id="tab-orders" class="tab-content">
                    <h3>Orders Log</h3>
                    <div class="table-container"><table><thead><tr><th>ID</th><th>Customer</th><th>Agent</th><th>Branch</th><th>Status</th><th>Action</th></tr></thead><tbody id="orders-table"></tbody></table></div>
                </div>

                <!-- Complaints Tab -->
                <div id="tab-complaints" class="tab-content hidden">
                    <h3>Complaints Log</h3>
                    <div class="table-container"><table><thead><tr><th>ID</th><th>Customer</th><th>Agent</th><th>Branch</th><th>Status</th><th>Action</th></tr></thead><tbody id="complaints-table"></tbody></table></div>
                </div>

                <!-- Leaderboard Tab -->
                <div id="tab-leaderboard" class="tab-content hidden">
                    <h3 style="color: var(--bronze); margin-bottom: 15px;">Top Performers Today</h3>
                    <div class="card" style="padding:0;">
                        <div class="table-container">
                            <table><thead><tr><th>Rank</th><th>Agent Name</th><th>Code</th><th>Completed Orders</th></tr></thead><tbody id="leaderboard-body"></tbody></table>
                        </div>
                    </div>
                </div>

                <!-- System Settings -->
                <div id="tab-system-settings" class="tab-content hidden">
                    <h3 style="color:var(--primary); margin-bottom:15px;">System Settings</h3>
                    <div class="card">
                        <h4>Branches</h4>
                        <div class="table-container"><table><thead><tr><th>Branch Name</th><th>Delete</th></tr></thead><tbody id="branches-table"></tbody></table></div>
                    </div>
                    <div class="card">
                        <h4>Agents</h4>
                        <div class="table-container"><table><thead><tr><th>Name</th><th>Code</th><th>Delete</th></tr></thead><tbody id="agents-table"></tbody></table></div>
                    </div>
                </div>
            </div>

            <!-- AGENT VIEW -->
            <div id="agent-view" class="hidden">
                <!-- Leaderboard Card -->
                <div id="agent-leaderboard" class="card trophy-card">
                    <div class="trophy-icon">üèÜ</div>
                    <div class="trophy-title">Top Agent Today</div>
                    <div class="trophy-winner" id="lb-winner-name">...</div>
                    <div class="trophy-score" id="lb-winner-score">...</div>
                </div>

                <div class="tabs">
                    <button class="tab-btn active" onclick="app.switchAgentTab('tasks')">üìã My Tasks</button>
                    <button class="tab-btn" onclick="app.switchAgentTab('add-order')">üìù New Order</button>
                    <button class="tab-btn" onclick="app.switchAgentTab('add-comp')">üö© Report Issue</button>
                </div>

                <!-- Agent Tasks (Orders + Directed Tasks) -->
                <div id="atab-tasks" class="agent-tab">
                    <h4>üì® Assigned Tasks (Manager)</h4>
                    <div id="my-directed-tasks-list" style="margin-bottom: 20px;"></div>
                    
                    <h4>üõµ My Delivery Orders</h4>
                    <div id="my-orders-list"></div>
                </div>

                <!-- Agent Add Order -->
                <div id="atab-add-order" class="agent-tab hidden">
                    <div class="card">
                        <h3>Place New Order</h3>
                        <div class="input-group"><label>Customer Name / Restaurant</label><input type="text" id="ao-client"></div>
                        <div class="input-group"><label>Branch</label><select id="ao-branch"></select></div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div class="input-group"><label>Date</label><input type="date" id="ao-date"></div>
                            <div class="input-group"><label>Time</label><input type="time" id="ao-time"></div>
                        </div>
                        <div class="input-group"><label>Delivery Address</label><textarea id="ao-address"></textarea></div>
                        <button class="btn btn-primary" style="width:100%" onclick="app.submitOrder()">Confirm Order</button>
                    </div>
                </div>

                <!-- Agent Add Complaint -->
                <div id="atab-add-comp" class="agent-tab hidden">
                    <div class="card">
                        <h3>Report Issue / Complaint</h3>
                        <div class="input-group"><label>Customer Name</label><input type="text" id="ac-client"></div>
                        <div class="input-group"><label>Branch</label><select id="ac-branch"></select></div>
                        <div class="input-group"><label>Invoice No.</label><input type="text" id="ac-invoice"></div>
                        <div class="input-group"><label>Details</label><textarea id="ac-details"></textarea></div>
                        <button class="btn btn-danger" style="width:100%" onclick="app.submitComplaint()">Submit Report</button>
                    </div>
                </div>
            </div>
        </main>
    </section>

    <!-- MODALS -->
    <div id="modal-add-task" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>Assign New Task</h3>
            <div class="input-group"><label>Task Title</label><input type="text" id="dt-title"></div>
            <div class="input-group"><label>Assign To Agent</label><select id="dt-agent"></select></div>
            
            <!-- CORE REQUEST: Specific Categories -->
            <div class="input-group">
                <label>Task Category (Foundation)</label>
                <select id="dt-type">
                    <option value="Customer Service">Customer Service</option>
                    <option value="Increase Sales">Increase Sales</option>
                    <option value="Follow-up Execution">Follow-up Execution</option>
                </select>
            </div>
            
            <div class="input-group"><label>Execution Time</label><input type="datetime-local" id="dt-time"></div>
            <div class="input-group"><label>Additional Details</label><textarea id="dt-desc"></textarea></div>
            <button class="btn btn-primary" style="width:100%" onclick="app.saveDirectedTask()">Assign Task</button>
            <button class="btn btn-outline" style="width:100%; margin-top:10px" onclick="app.closeModal('add-task')">Cancel</button>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC V6 -->
    <script type="module">
        // 1. English Date Logic
        function updateEnglishDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateString = now.toLocaleDateString('en-US', options);
            document.getElementById('current-date').textContent = dateString;
        }
        setInterval(updateEnglishDate, 1000);
        updateEnglishDate();

        // 2. Data & Initialization
        const INITIAL_DATA = {
            users: [
                { uid: 'mgr1', name: 'Admin Manager', email: 'admin@sys.com', role: 'manager', code: 'MGR-001' },
                { uid: 'a1', name: 'AHMED KENAWY', email: 'ahmed@sys.com', role: 'agent', code: '00144' },
                { uid: 'a2', name: 'SALAH AHMED', email: 'salah@sys.com', role: 'agent', code: 'CC005' },
                { uid: 'a3', name: 'Nona Rose', email: 'nona@sys.com', role: 'agent', code: 'CC03' },
                { uid: 'a4', name: 'Melvin compendio', email: 'melvin@sys.com', role: 'agent', code: 'N/A' },
                { uid: 'a5', name: 'Asmita Sapkota', email: 'asmita@sys.com', role: 'agent', code: 'N/A' },
                { uid: 'a6', name: 'Manju Ranabhat', email: 'manju@sys.com', role: 'agent', code: 'N/A' },
                { uid: 'a7', name: 'Nirjala', email: 'nirjala@sys.com', role: 'agent', code: 'N/A' },
                { uid: 'a8', name: 'HANA', email: 'hana@sys.com', role: 'agent', code: 'N/A' },
                { uid: 'a9', name: 'HANA', email: 'hana2@sys.com', role: 'agent', code: 'CC009' }
            ],
            branches: [
                "Crispy Chicken-Hamdan St", "Crispy Chicken Khaldia", "Crispy Chicken Shabiya 11", "Crispy Chicken Muroor",
                "Crispy Chicken Al Electra", "Crispy Chicken Al Barsha", "Crispy Chicken Al Satwa", "Crispy Chicken Al Rigga", "Crispy Chicken Al Majaz"
            ],
            orders: [],
            complaints: [],
            directedTasks: [] 
        };

        class DataManager {
            constructor() {
                if(!localStorage.getItem('crispy_init_v6')) {
                    this.save('crispy_users', INITIAL_DATA.users);
                    this.save('crispy_branches', INITIAL_DATA.branches);
                    this.save('crispy_orders', INITIAL_DATA.orders);
                    this.save('crispy_complaints', INITIAL_DATA.complaints);
                    this.save('crispy_directedTasks', INITIAL_DATA.directedTasks);
                    localStorage.setItem('crispy_init_v6', 'true');
                }
            }
            get(key) { return JSON.parse(localStorage.getItem(key)) || []; }
            save(key, val) { localStorage.setItem(key, JSON.stringify(val)); }
            
            login(email, pass) {
                const users = this.get('crispy_users');
                const user = users.find(u => u.email === email);
                if (user && pass === '123456') return user;
                throw new Error("Invalid credentials");
            }

            // Stats Logic
            getStats() {
                return {
                    orders: this.get('crispy_orders').length,
                    complaints: this.get('crispy_complaints').length,
                    tasks: this.get('crispy_directedTasks').length,
                    agents: this.get('crispy_users').filter(u => u.role === 'agent').length
                };
            }

            calculateLeaderboard() {
                const users = this.get('crispy_users').filter(u => u.role === 'agent');
                const orders = this.get('crispy_orders');
                const scores = users.map(user => {
                    const completedCount = orders.filter(o => o.agentId === user.uid && o.status === 'Done').length;
                    return { ...user, score: completedCount };
                });
                return scores.sort((a, b) => b.score - a.score);
            }

            // Data Actions
            addOrder(data) {
                const list = this.get('crispy_orders');
                data.id = 'ORD-'+Math.floor(Math.random()*10000);
                data.status = 'Pending';
                list.push(data);
                this.save('crispy_orders', list);
            }
            addComp(data) {
                const list = this.get('crispy_complaints');
                data.id = 'COMP-'+Math.floor(Math.random()*10000);
                data.status = 'Open';
                list.push(data);
                this.save('crispy_complaints', list);
            }
            addDirectedTask(data) {
                const list = this.get('crispy_directedTasks');
                data.id = 'TSK-'+Math.floor(Math.random()*10000);
                data.status = 'Pending';
                list.push(data);
                this.save('crispy_directedTasks', list);
            }
            
            updateStatus(key, id, status) {
                const list = this.get(key);
                const item = list.find(x => x.id === id);
                if(item) { item.status = status; this.save(key, list); }
            }

            // System Management
            addBranch(name) { const l = this.get('crispy_branches'); l.push(name); this.save('crispy_branches', l); }
            removeBranch(idx) { const l = this.get('crispy_branches'); l.splice(idx, 1); this.save('crispy_branches', l); }
            addAgent(data) { const l = this.get('crispy_users'); data.uid='u'+Date.now(); data.role='agent'; l.push(data); this.save('crispy_users', l); }
            removeAgent(uid) { let l = this.get('crispy_users'); l = l.filter(u => u.uid !== uid); this.save('crispy_users', l); }
        }

        const db = new DataManager();
        let currentUser = null;

        window.app = {
            login: async () => {
                const email = document.getElementById('login-email').value;
                const pass = document.getElementById('login-password').value;
                try {
                    currentUser = await db.login(email, pass);
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('app-layout').style.display = 'block';
                    app.loadView();
                } catch(e) { alert(e.message); }
            },
            logout: () => location.reload(),
            loadView: () => {
                document.getElementById('user-info').textContent = `${currentUser.name} (${currentUser.role})`;
                if(currentUser.role === 'manager') {
                    document.getElementById('manager-view').classList.remove('hidden');
                    app.renderManager();
                } else {
                    document.getElementById('agent-view').classList.remove('hidden');
                    app.renderAgent();
                }
            },

            // --- MANAGER RENDER ---
            renderManager: () => {
                const agents = db.get('crispy_users').filter(u => u.role === 'agent');
                
                // Stats
                const stats = db.getStats();
                document.getElementById('stat-orders').textContent = stats.orders;
                document.getElementById('stat-complaints').textContent = stats.complaints;
                document.getElementById('stat-tasks').textContent = stats.tasks;
                document.getElementById('stat-agents').textContent = stats.agents;

                // Orders Table
                const orders = db.get('crispy_orders');
                document.getElementById('orders-table').innerHTML = orders.map(o => {
                    const agent = agents.find(a => a.uid === o.agentId)?.name || 'Unknown';
                    return `<tr><td>${o.id}</td><td>${o.client}</td><td>${agent}</td><td>${o.branch}</td><td><span class="badge badge-${o.status==='Done'?'done':'pending'}">${o.status}</span></td><td>${o.status!=='Done'?`<button class="btn btn-success" style="padding:2px 5px;font-size:0.7rem" onclick="app.updateStatus('crispy_orders','${o.id}','Done')">Done</button>`:'-'}</td></tr>`;
                }).join('');

                // Tasks Table
                const tasks = db.get('crispy_directedTasks');
                document.getElementById('tasks-table').innerHTML = tasks.map(t => {
                    const agent = agents.find(a => a.uid === t.agentId)?.name || 'Unknown';
                    return `<tr><td>${t.title}</td><td>${agent}</td><td><span class="badge badge-task">${t.type}</span></td><td>${t.time}</td><td><span class="badge badge-${t.status==='Done'?'done':'pending'}">${t.status}</span></td><td>${t.status!=='Done'?`<button class="btn btn-outline" style="padding:2px 5px;font-size:0.7rem" onclick="app.updateStatus('crispy_directedTasks','${t.id}','Done')">Close</button>`:'-'}</td></tr>`;
                }).join('');

                // Complaints Table
                const complaints = db.get('crispy_complaints');
                document.getElementById('complaints-table').innerHTML = complaints.map(c => {
                    const agent = agents.find(a => a.uid === c.agentId)?.name || 'Unknown';
                    return `<tr><td>${c.id}</td><td>${c.client}</td><td>${agent}</td><td>${c.branch}</td><td><span class="badge badge-pending">${c.status}</span></td><td><button class="btn btn-outline" style="padding:2px 5px;font-size:0.7rem" onclick="app.updateStatus('crispy_complaints','${c.id}','Resolved')">Resolve</button></td></tr>`;
                }).join('');

                // Leaderboard
                const rankedAgents = db.calculateLeaderboard();
                document.getElementById('leaderboard-body').innerHTML = rankedAgents.map((a, index) => {
                    const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : '';
                    const icon = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                    return `<tr class="${rankClass}"><td>${index + 1} ${icon}</td><td><strong>${a.name}</strong></td><td>${a.code}</td><td>${a.score}</td></tr>`;
                }).join('');

                // Settings
                const branches = db.get('crispy_branches');
                document.getElementById('branches-table').innerHTML = branches.map((b, i) => `<tr><td>${b}</td><td><button class="btn btn-danger" style="padding:2px 5px" onclick="app.delBranch(${i})">Delete</button></td></tr>`).join('');
                document.getElementById('agents-table').innerHTML = agents.map(a => `<tr><td>${a.name}</td><td>${a.code}</td><td><button class="btn btn-danger" style="padding:2px 5px" onclick="app.delAgent('${a.uid}')">Delete</button></td></tr>`).join('');
            },

            // --- AGENT RENDER ---
            renderAgent: () => {
                const orders = db.get('crispy_orders').filter(o => o.agentId === currentUser.uid);
                const directedTasks = db.get('crispy_directedTasks').filter(t => t.agentId === currentUser.uid);
                const branches = db.get('crispy_branches');
                const rankedAgents = db.calculateLeaderboard();
                const winner = rankedAgents[0];

                // Dropdowns
                const opts = branches.map(b => `<option value="${b}">${b}</option>`).join('');
                document.getElementById('ao-branch').innerHTML = opts;
                document.getElementById('ac-branch').innerHTML = opts;

                // Leaderboard
                const wn = document.getElementById('lb-winner-name');
                const ws = document.getElementById('lb-winner-score');
                if(winner && winner.score > 0) {
                    wn.textContent = winner.name;
                    ws.textContent = `${winner.score} Orders`;
                    if(winner.uid === currentUser.uid) { wn.parentElement.style.borderColor = "var(--gold)"; }
                } else {
                    wn.textContent = "No Activity";
                    ws.textContent = "0 Orders";
                }

                // Render Directed Tasks
                document.getElementById('my-directed-tasks-list').innerHTML = directedTasks.length ? directedTasks.map(t => `
                    <div class="card" style="border-left: 4px solid var(--primary);">
                        <div style="display:flex; justify-content:space-between;">
                            <h4>${t.title}</h4>
                            <span class="badge badge-task">${t.type}</span>
                        </div>
                        <p style="font-size:0.9rem; margin:5px 0;">‚è∞ ${t.time}</p>
                        <p style="font-size:0.8rem; color:#666;">${t.desc || ''}</p>
                        <div style="margin-top:10px;">
                            Status: <span class="badge badge-${t.status==='Done'?'done':'pending'}">${t.status}</span>
                            ${t.status!=='Done' ? `<button class="btn btn-success" style="padding:2px 8px; font-size:0.8rem" onclick="app.updateStatus('crispy_directedTasks','${t.id}','Done'); app.renderAgent()">Completed</button>` : ''}
                        </div>
                    </div>
                `).join('') : '<p style="font-size:0.9rem; color:#888;">No assigned tasks currently</p>';

                // Render Orders
                document.getElementById('my-orders-list').innerHTML = orders.length ? orders.map(o => `
                    <div class="card" style="border-left:4px solid ${o.status==='Done'?'var(--success)':'var(--warning)'}">
                        <h4>${o.client} (${o.branch})</h4>
                        <p style="font-size:0.9rem;color:#666">üìÖ ${o.date} ${o.time} | üìç ${o.address}</p>
                        <div style="margin-top:10px;">Status: <span class="badge badge-${o.status==='Done'?'done':'pending'}">${o.status}</span></div>
                    </div>
                `).join('') : '';
            },

            // --- GENERAL ACTIONS ---
            switchTab: (t) => {
                document.querySelectorAll('.tab-content').forEach(x=>x.classList.add('hidden'));
                document.querySelectorAll('#manager-view .tab-btn').forEach(b=>b.classList.remove('active'));
                document.getElementById('tab-'+t).classList.remove('hidden');
                event.target.classList.add('active');
            },
            switchAgentTab: (t) => {
                document.querySelectorAll('.agent-tab').forEach(x=>x.classList.add('hidden'));
                document.querySelectorAll('#agent-view .tab-btn').forEach(b=>b.classList.remove('active'));
                document.getElementById('atab-'+t).classList.remove('hidden');
                event.target.classList.add('active');
            },
            
            // Modals
            openModal: (id) => {
                if(id === 'add-task') {
                    const agents = db.get('crispy_users').filter(u => u.role === 'agent');
                    document.getElementById('dt-agent').innerHTML = agents.map(a => `<option value="${a.uid}">${a.name}</option>`).join('');
                }
                document.getElementById('modal-'+id).classList.remove('hidden');
            },
            closeModal: (id) => document.getElementById('modal-'+id).classList.add('hidden'),

            saveDirectedTask: () => {
                const data = {
                    title: document.getElementById('dt-title').value,
                    agentId: document.getElementById('dt-agent').value,
                    type: document.getElementById('dt-type').value,
                    time: document.getElementById('dt-time').value,
                    desc: document.getElementById('dt-desc').value
                };
                if(!data.title || !data.agentId) return alert('Missing information');
                db.addDirectedTask(data);
                app.closeModal('add-task');
                app.renderManager();
            },

            updateStatus: (key, id, status) => {
                db.updateStatus(key, id, status);
                if(currentUser.role === 'manager') app.renderManager();
                else app.renderAgent();
            },

            // Agent Actions
            submitOrder: () => {
                db.addOrder({
                    client: document.getElementById('ao-client').value,
                    branch: document.getElementById('ao-branch').value,
                    date: document.getElementById('ao-date').value,
                    time: document.getElementById('ao-time').value,
                    address: document.getElementById('ao-address').value,
                    agentId: currentUser.uid
                });
                alert('Order Confirmed'); app.switchAgentTab('tasks'); app.renderAgent();
            },
            submitComplaint: () => {
                db.addComp({
                    client: document.getElementById('ac-client').value,
                    branch: document.getElementById('ac-branch').value,
                    invoice: document.getElementById('ac-invoice').value,
                    details: document.getElementById('ac-details').value,
                    agentId: currentUser.uid
                });
                alert('Report Submitted'); app.switchAgentTab('tasks');
            },

            // System Actions
            saveBranch: () => { const n=document.getElementById('new-branch-name').value; if(n){db.addBranch(n); app.closeModal(); app.renderManager();}},
            delBranch: (i) => { if(confirm('Delete?')){db.removeBranch(i); app.renderManager();}},
            saveAgent: () => { const n=document.getElementById('new-agent-name').value; const c=document.getElementById('new-agent-code').value; const e=document.getElementById('new-agent-email').value; if(n && e){db.addAgent({name:n,code:c,email:e}); app.closeModal(); app.renderManager();}},
            delAgent: (uid) => { if(confirm('Delete?')){db.removeAgent(uid); app.renderManager();}}
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crispy Call Center System - Employee List Loaded</title>
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --primary: #dc2626;
            --primary-dark: #991b1b;
            --bg: #f1f5f9;
            --surface: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Dark Mode */
        body.dark-mode {
            --bg: #0f172a;
            --surface: #1e293b;
            --text: #f1f5f9;
            --border: #334155;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg); 
            color: var(--text); 
            transition: background-color 0.3s;
            min-height: 100vh;
        }

        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .text-center { text-align: center; }
        .w-full { width: 100%; }
        .relative { position: relative; }

        /* --- LOGIN SCREEN STYLES --- */
        #auth-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, #450a0a 100%);
            padding: 20px;
        }

        .login-box {
            background: var(--surface);
            width: 100%;
            max-width: 400px;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Shake Animation for Error */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake-anim { animation: shake 0.5s ease-in-out; border-color: var(--primary) !important; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .password-wrapper { position: relative; }
        .toggle-password {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--border);
            background: none;
            border: none;
            font-size: 1rem;
        }
        .toggle-password:hover { color: var(--text); }

        /* --- DASHBOARD STYLES --- */
        #app-layout { display: none; min-height: 100vh; }
        
        header {
            background: var(--surface);
            padding: 15px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        main { padding: 30px; max-width: 1400px; margin: 0 auto; width: 100%; }

        /* Cards & Buttons */
        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.1s, opacity 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3); }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
        .btn-sm { padding: 4px 8px; font-size: 0.8rem; }
        .btn-text { background: none; color: var(--secondary); font-size: 0.85rem; text-decoration: underline; padding: 0; }

        .input-control {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            margin-bottom: 15px;
            transition: border-color 0.2s;
        }
        .input-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1); }

        /* Badges */
        .badge {
            padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700;
        }
        .badge-done { background: #dcfce7; color: #166534; }
        .badge-pending { background: #fef9c3; color: #854d0e; }
        .badge-task { background: #f3e8ff; color: #6b21a8; }

        /* Tables */
        .table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: var(--bg); font-weight: 600; font-size: 0.8rem; text-transform: uppercase; color: var(--secondary); }

        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 1px; overflow-x: auto;}
        .tab-btn {
            padding: 10px 20px; border-radius: 8px 8px 0 0; cursor: pointer;
            background: transparent; color: var(--secondary); border-bottom: 3px solid transparent; font-weight: 600;
        }
        .tab-btn:hover { color: var(--primary); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* Dashboard Grid */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card h2 { font-size: 2.5rem; color: var(--primary); margin: 0; }
        
        /* Toast Notification */
        .toast {
            position: fixed; top: 20px; right: 20px;
            background: var(--surface); padding: 15px 20px;
            border-radius: 8px; box-shadow: var(--shadow);
            display: flex; align-items: center; gap: 10px;
            border-left: 5px solid var(--primary);
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }
        .toast.success { border-left-color: #10b981; }
        .toast.error { border-left-color: #ef4444; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

    </style>
</head>
<body>

    <!-- TOASTS -->
    <div id="toast-container"></div>

    <!-- LOGIN SCREEN -->
    <section id="auth-screen">
        <div class="login-box" id="login-box">
            <div class="text-center" style="margin-bottom: 25px;">
                <i class="fas fa-drumstick-bite" style="font-size: 3.5rem; color: var(--primary); margin-bottom: 15px;"></i>
                <h2 style="color: var(--text);">Crispy System</h2>
                <p style="color: var(--secondary); font-size: 0.9rem;">Secure Access Portal</p>
            </div>
            
            <div class="input-group">
                <input type="email" id="login-email" class="input-control" placeholder="Email Address" autocomplete="email">
            </div>
            
            <div class="input-group password-wrapper">
                <input type="password" id="login-password" class="input-control" placeholder="Password" autocomplete="current-password">
                <button type="button" class="toggle-password" onclick="app.togglePassVisibility()">
                    <i class="fas fa-eye" id="eye-icon"></i>
                </button>
            </div>

            <button id="login-btn" class="btn btn-primary w-full" onclick="app.login()" style="padding: 12px;">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                <button class="btn btn-text w-full" onclick="app.resetSystem()">
                    <i class="fas fa-trash-alt"></i> Reset System Data
                </button>
                <div style="margin-top: 15px; font-size: 0.8rem; color: var(--secondary); line-height: 1.6; background: var(--bg); padding: 10px; border-radius: 6px;">
                    <strong>Demo Credentials:</strong><br>
                    Manager: <code>admin@crispy.com</code> / <code>123456</code><br>
                    Agent: <code>saleh@crispy.com</code> / <code>123456</code>
                </div>
            </div>
        </div>
    </section>

    <!-- MAIN APP -->
    <section id="app-layout">
        <header>
            <div class="flex items-center gap-2">
                <i class="fas fa-drumstick-bite" style="color: var(--primary); font-size: 1.5rem;"></i>
                <h3 id="header-title" style="color: var(--text);">Dashboard</h3>
            </div>
            <div class="flex items-center gap-4">
                <span id="date-display" style="font-family: monospace; font-size: 0.9rem; color: var(--secondary);"></span>
                <button class="btn btn-outline btn-sm" onclick="app.toggleTheme()"><i class="fas fa-moon"></i></button>
                <div class="text-center" style="line-height: 1.1;">
                    <span id="user-name" style="font-weight: bold; display: block; font-size: 0.9rem;">User</span>
                    <span id="user-role" style="font-size: 0.75rem; color: var(--secondary);">ROLE</span>
                </div>
                <button class="btn btn-outline btn-sm" style="border-color: var(--danger); color: var(--danger);" onclick="app.logout()">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <main id="main-container">
            <!-- Dynamic Content Here -->
        </main>
    </section>

    <!-- MODAL -->
    <div id="modal-overlay" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:100; display:flex; justify-content:center; align-items:center;">
        <div class="login-box" style="max-width:500px; animation: slideUp 0.3s;">
            <h3 id="modal-title" style="margin-bottom:15px;">Modal</h3>
            <div id="modal-body"></div>
            <div class="flex gap-2 mt-4">
                <button class="btn btn-primary w-full" id="modal-confirm-btn">Confirm</button>
                <button class="btn btn-outline w-full" onclick="app.closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & DATA ---
        const DB_KEYS = { USERS: 'c_users', ORDERS: 'c_orders', TASKS: 'c_tasks', COMPLAINTS: 'c_complaints', BRANCHES: 'c_branches' };

        // Robust Seeding - Updates with specific employee list
        const seedData = () => {
            if(!localStorage.getItem(DB_KEYS.USERS)) {
                
                // 1. Manager Account
                const admin = { id: 1, name: 'Admin Manager', email: 'admin@crispy.com', pass: '123456', role: 'manager', code: 'MGR-01' };

                // 2. SPECIFIC EMPLOYEE LIST (Mapped from prompt)
                const employees = [
                    { id: 2, name: 'AHMEDKENAWY MOHAMED', email: 'ahmed@crispy.com', pass: '123456', role: 'agent', code: 'MG-00' },
                    { id: 3, name: 'Saleh Emad', email: 'saleh@crispy.com', pass: '123456', role: 'agent', code: 'JD-001' },
                    { id: 4, name: 'Nona Rose', email: 'nona@crispy.com', pass: '123456', role: 'agent', code: 'JD-002' },
                    { id: 5, name: 'Melvin compendio', email: 'melvin@crispy.com', pass: '123456', role: 'agent', code: 'JD-003' },
                    { id: 6, name: 'Asmita Sapkota', email: 'asmita@crispy.com', pass: '123456', role: 'agent', code: 'JD-004' },
                    { id: 7, name: 'Manju Ranabhat', email: 'manju@crispy.com', pass: '123456', role: 'agent', code: 'JD-005' },
                    { id: 8, name: 'Nirjala', email: 'nirjala@crispy.com', pass: '123456', role: 'agent', code: 'JD-006' },
                    { id: 9, name: 'Firoza Nahhed', email: 'firoza@crispy.com', pass: '123456', role: 'agent', code: 'JD-007' }
                ];

                const initialUsers = [admin, ...employees];
                
                localStorage.setItem(DB_KEYS.USERS, JSON.stringify(initialUsers));
                localStorage.setItem(DB_KEYS.BRANCHES, JSON.stringify(['Main Branch', 'City Center', 'Mall Outlet', 'Airport Road']));
                localStorage.setItem(DB_KEYS.ORDERS, JSON.stringify([]));
                localStorage.setItem(DB_KEYS.TASKS, JSON.stringify([]));
                localStorage.setItem(DB_KEYS.COMPLAINTS, JSON.stringify([]));
                console.log("System Data Seeded Successfully (Updated Employees)");
            }
        };

        // Data Access Layer
        const db = {
            get: (key) => {
                try { return JSON.parse(localStorage.getItem(key)) || []; } 
                catch(e) { return []; }
            },
            set: (key, val) => localStorage.setItem(key, JSON.stringify(val)),
            add: (key, item) => {
                const list = db.get(key);
                item.id = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                item.createdAt = new Date().toISOString();
                list.push(item);
                db.set(key, list);
                return item;
            },
            update: (key, id, updates) => {
                const list = db.get(key);
                const idx = list.findIndex(i => i.id === id);
                if(idx > -1) {
                    list[idx] = { ...list[idx], ...updates };
                    db.set(key, list);
                    return true;
                }
                return false;
            },
            delete: (key, id) => {
                const list = db.get(key).filter(i => i.id !== id);
                db.set(key, list);
            }
        };

        // Application Logic
        const app = {
            currentUser: null,
            chart: null,

            init: () => {
                seedData(); // Ensure data is there
                app.updateDate();
                
                // Theme Load
                if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
            },

            updateDate: () => {
                const d = new Date();
                document.getElementById('date-display').innerText = d.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            },

            toggleTheme: () => {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            },

            togglePassVisibility: () => {
                const input = document.getElementById('login-password');
                const icon = document.getElementById('eye-icon');
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.className = 'fas fa-eye-slash';
                } else {
                    input.type = 'password';
                    icon.className = 'fas fa-eye';
                }
            },

            resetSystem: () => {
                if(confirm("WARNING: This will delete ALL data (Orders, Tasks, Users) and reset the system with the new employee list. Continue?")) {
                    localStorage.clear();
                    location.reload();
                }
            },

            // --- FIXED LOGIN LOGIC ---
            login: () => {
                const emailInput = document.getElementById('login-email');
                const passInput = document.getElementById('login-password');
                const btn = document.getElementById('login-btn');
                const box = document.getElementById('login-box');

                const rawEmail = emailInput.value;
                const rawPass = passInput.value;

                // 1. Basic Validation
                if (!rawEmail || !rawPass) {
                    app.shakeBox();
                    app.toast('Please enter email and password', 'error');
                    return;
                }

                // 2. Sanitize Inputs
                const email = rawEmail.trim().toLowerCase();
                const pass = rawPass.trim();

                // 3. UI Loading State
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
                btn.disabled = true;

                // 4. Fetch Users (Safety Check)
                let users = db.get(DB_KEYS.USERS);
                
                // If users array is empty (corruption), force seed immediately
                if(users.length === 0) {
                    seedData();
                    users = db.get(DB_KEYS.USERS);
                }

                // 5. Authenticate
                const user = users.find(u => u.email.toLowerCase() === email && u.pass === pass);

                // Simulate network delay for realism
                setTimeout(() => {
                    if (user) {
                        app.currentUser = user;
                        document.getElementById('auth-screen').classList.add('hidden');
                        document.getElementById('app-layout').style.display = 'block';
                        
                        // Set Header Info
                        document.getElementById('user-name').innerText = user.name;
                        document.getElementById('user-role').innerText = `${user.role.toUpperCase()} [Code: ${user.code}]`;

                        // Route
                        if(user.role === 'manager') app.renderManager();
                        else app.renderAgent();

                        app.toast(`Welcome, ${user.name}`, 'success');
                    } else {
                        app.shakeBox();
                        app.toast('Invalid Email or Password', 'error');
                        btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
                        btn.disabled = false;
                    }
                }, 600);
            },

            shakeBox: () => {
                const box = document.getElementById('login-box');
                box.classList.remove('shake-anim');
                void box.offsetWidth; // trigger reflow
                box.classList.add('shake-anim');
            },

            logout: () => {
                app.currentUser = null;
                document.getElementById('app-layout').style.display = 'none';
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';
                document.getElementById('login-btn').innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
                document.getElementById('login-btn').disabled = false;
                // Destroy chart to free memory
                if(app.chart) app.chart.destroy();
            },

            toast: (msg, type = 'info') => {
                const c = document.getElementById('toast-container');
                const t = document.createElement('div');
                t.className = `toast ${type}`;
                t.innerHTML = `
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <span>${msg}</span>
                `;
                c.appendChild(t);
                setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 3000);
            },

            // --- MANAGER VIEW ---
            renderManager: () => {
                document.getElementById('header-title').innerText = 'Manager Dashboard';
                const orders = db.get(DB_KEYS.ORDERS);
                const users = db.get(DB_KEYS.USERS);
                
                const container = document.getElementById('main-container');
                container.innerHTML = `
                    <div class="dashboard-grid">
                        <div class="card stat-card">
                            <p style="color:var(--secondary)">Total Orders</p>
                            <h2>${orders.length}</h2>
                        </div>
                        <div class="card stat-card">
                            <p style="color:var(--secondary)">Pending</p>
                            <h2 style="color:var(--warning)">${orders.filter(o=>o.status==='Pending').length}</h2>
                        </div>
                        <div class="card stat-card">
                            <p style="color:var(--secondary)">Agents</p>
                            <h2>${users.filter(u=>u.role==='agent').length}</h2>
                        </div>
                        <div class="card stat-card">
                            <p style="color:var(--secondary)">Active Tasks</p>
                            <h2>${db.get(DB_KEYS.TASKS).length}</h2>
                        </div>
                    </div>

                    <div class="tabs">
                        <button class="tab-btn active" onclick="app.mTab('overview')">Overview</button>
                        <button class="tab-btn" onclick="app.mTab('tasks')">Assign Tasks</button>
                        <button class="tab-btn" onclick="app.mTab('orders')">Orders Log</button>
                        <button class="tab-btn" onclick="app.mTab('employees')">Employees</button>
                    </div>

                    <div id="m-overview">
                        <div class="card" style="height: 300px;">
                            <canvas id="mainChart"></canvas>
                        </div>
                    </div>
                    <div id="m-tasks" class="hidden">
                        <div class="flex justify-between" style="margin-bottom:15px">
                            <h3>Directed Tasks</h3>
                            <button class="btn btn-primary btn-sm" onclick="app.openTaskModal()">New Task</button>
                        </div>
                        <div class="card table-wrapper">
                            <table id="tasks-table"></table>
                        </div>
                    </div>
                    <div id="m-orders" class="hidden">
                        <div class="flex justify-between" style="margin-bottom:15px">
                            <h3>All Orders</h3>
                        </div>
                        <div class="card table-wrapper">
                            <table id="orders-table"></table>
                        </div>
                    </div>
                    <div id="m-employees" class="hidden">
                        <div class="flex justify-between" style="margin-bottom:15px">
                            <h3>Employee Directory</h3>
                        </div>
                        <div class="card table-wrapper">
                            <table id="employees-table"></table>
                        </div>
                    </div>
                `;

                // Render Chart
                const ctx = document.getElementById('mainChart').getContext('2d');
                if(app.chart) app.chart.destroy();
                app.chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Completed', 'Pending'],
                        datasets: [{
                            data: [
                                orders.filter(o=>o.status==='Done').length,
                                orders.filter(o=>o.status==='Pending').length
                            ],
                            backgroundColor: ['#10b981', '#f59e0b']
                        }]
                    },
                    options: { maintainAspectRatio: false }
                });

                // Render Tables
                app.renderManagerTables();
            },

            mTab: (id) => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');
                document.getElementById(`m-overview`).classList.add('hidden');
                document.getElementById(`m-tasks`).classList.add('hidden');
                document.getElementById(`m-orders`).classList.add('hidden');
                document.getElementById(`m-employees`).classList.add('hidden');
                document.getElementById(`m-${id}`).classList.remove('hidden');
                app.renderManagerTables(); // Refresh data on tab switch
            },

            renderManagerTables: () => {
                const orders = db.get(DB_KEYS.ORDERS);
                const tasks = db.get(DB_KEYS.TASKS);
                const users = db.get(DB_KEYS.USERS);

                // Orders
                document.getElementById('orders-table').innerHTML = `
                    <thead><tr><th>ID</th><th>Customer</th><th>Agent</th><th>Status</th><th>Action</th></tr></thead>
                    <tbody>
                        ${orders.map(o => {
                            const u = users.find(x => x.id == o.agentId) || {name: 'Unknown', code:'?'};
                            return `<tr>
                                <td>${o.id.substr(0,5)}...</td>
                                <td>${o.customer}</td>
                                <td>${u.name} <span class="badge badge-task" style="font-size:0.6rem">${u.code}</span></td>
                                <td><span class="badge ${o.status==='Done'?'badge-done':'badge-pending'}">${o.status}</span></td>
                                <td>${o.status==='Pending' ? `<button class="btn btn-primary btn-sm" onclick="app.updateStatus('${DB_KEYS.ORDERS}','${o.id}','Done')">Done</button>` : '-'}</td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                `;

                // Tasks
                document.getElementById('tasks-table').innerHTML = `
                    <thead><tr><th>Task</th><th>Category</th><th>Agent</th><th>Status</th><th>Action</th></tr></thead>
                    <tbody>
                        ${tasks.map(t => {
                            const u = users.find(x => x.id == t.agentId) || {name: 'Unknown', code:'?'};
                            return `<tr>
                                <td>${t.title}</td>
                                <td>${t.category}</td>
                                <td>${u.name} <span class="badge badge-task" style="font-size:0.6rem">${u.code}</span></td>
                                <td><span class="badge ${t.status==='Done'?'badge-done':'badge-task'}">${t.status}</span></td>
                                <td>${t.status==='Pending' ? `<button class="btn btn-primary btn-sm" onclick="app.updateStatus('${DB_KEYS.TASKS}','${t.id}','Done')">Complete</button>` : '-'}</td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                `;

                // Employees (New Tab)
                document.getElementById('employees-table').innerHTML = `
                    <thead><tr><th>Name</th><th>Job Number (Code)</th><th>Email</th><th>Role</th></tr></thead>
                    <tbody>
                        ${users.map(u => `
                            <tr>
                                <td>${u.name}</td>
                                <td><span class="badge badge-done">${u.code}</span></td>
                                <td>${u.email}</td>
                                <td>${u.role}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
            },

            // --- AGENT VIEW ---
            renderAgent: () => {
                document.getElementById('header-title').innerText = 'Agent Workspace';
                const myOrders = db.get(DB_KEYS.ORDERS).filter(o => o.agentId == app.currentUser.id).reverse();
                const myTasks = db.get(DB_KEYS.TASKS).filter(t => t.agentId == app.currentUser.id).reverse();
                const branches = db.get(DB_KEYS.BRANCHES);

                document.getElementById('main-container').innerHTML = `
                    <div class="dashboard-grid">
                        <div class="card">
                            <h4>My Tasks</h4>
                            <div style="margin-top:10px">
                                ${myTasks.length === 0 ? '<p class="text-secondary">No tasks assigned.</p>' : myTasks.map(t => `
                                    <div style="border:1px solid var(--border); padding:10px; border-radius:6px; margin-bottom:8px; background:var(--bg)">
                                        <strong>${t.title}</strong> <span class="badge badge-task">${t.category}</span><br>
                                        <small>${t.status === 'Done' ? 'Completed' : 'Pending'}</small>
                                        ${t.status === 'Pending' ? `<button class="btn btn-primary btn-sm w-full mt-4" onclick="app.updateStatus('${DB_KEYS.TASKS}','${t.id}','Done'); app.renderAgent()">Mark Done</button>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="card">
                            <h4>My Orders</h4>
                            <div style="margin-top:10px">
                                ${myOrders.length === 0 ? '<p class="text-secondary">No orders placed.</p>' : myOrders.map(o => `
                                    <div style="border:1px solid var(--border); padding:10px; border-radius:6px; margin-bottom:8px; background:var(--bg)">
                                        <strong>${o.customer}</strong> (${o.branch})<br>
                                        <span class="badge ${o.status==='Done'?'badge-done':'badge-pending'}">${o.status}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="tabs">
                        <button class="tab-btn active" onclick="app.aTab('new')">New Order</button>
                        <button class="tab-btn" onclick="app.aTab('list')">Order List</button>
                    </div>

                    <div id="a-new">
                        <div class="card" style="max-width:600px; margin:0 auto;">
                            <h3>Place New Order</h3>
                            <input id="ao-customer" class="input-control" placeholder="Customer Name">
                            <select id="ao-branch" class="input-control">${branches.map(b=>`<option>${b}</option>`)}</select>
                            <textarea id="ao-details" class="input-control" placeholder="Order Details / Items" rows="3"></textarea>
                            <button class="btn btn-primary w-full" onclick="app.placeOrder()">Submit Order</button>
                        </div>
                    </div>
                    <div id="a-list" class="hidden">
                        <div class="card table-wrapper">
                            <table>
                                <thead><tr><th>ID</th><th>Customer</th><th>Status</th></tr></thead>
                                <tbody>
                                    ${myOrders.map(o => `
                                        <tr>
                                            <td>${o.id.substr(0,6)}</td>
                                            <td>${o.customer}</td>
                                            <td><span class="badge ${o.status==='Done'?'badge-done':'badge-pending'}">${o.status}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            },

            aTab: (id) => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');
                document.getElementById('a-new').classList.add('hidden');
                document.getElementById('a-list').classList.add('hidden');
                document.getElementById(`a-${id}`).classList.remove('hidden');
            },

            // --- ACTIONS ---
            openTaskModal: () => {
                const agents = db.get(DB_KEYS.USERS).filter(u => u.role === 'agent');
                const overlay = document.getElementById('modal-overlay');
                const body = document.getElementById('modal-body');
                
                overlay.classList.remove('hidden');
                document.getElementById('modal-title').innerText = 'Assign New Task';
                
                body.innerHTML = `
                    <input id="mt-title" class="input-control" placeholder="Task Title">
                    <select id="mt-agent" class="input-control">${agents.map(a => `<option value="${a.id}">${a.name} (${a.code})</option>`)}</select>
                    <select id="mt-cat" class="input-control">
                        <option value="Customer Service">Customer Service</option>
                        <option value="Increase Sales">Increase Sales</option>
                        <option value="Follow-up Execution">Follow-up Execution</option>
                    </select>
                `;

                document.getElementById('modal-confirm-btn').onclick = () => {
                    const title = document.getElementById('mt-title').value;
                    const agent = document.getElementById('mt-agent').value;
                    const cat = document.getElementById('mt-cat').value;
                    if(!title) return alert('Enter a title');

                    db.add(DB_KEYS.TASKS, { title, agentId: agent, category: cat, status: 'Pending' });
                    app.closeModal();
                    app.renderManager();
                    app.toast('Task Assigned', 'success');
                };
            },

            closeModal: () => {
                document.getElementById('modal-overlay').classList.add('hidden');
            },

            placeOrder: () => {
                const cust = document.getElementById('ao-customer').value;
                const branch = document.getElementById('ao-branch').value;
                const details = document.getElementById('ao-details').value;
                
                if(!cust || !details) return alert('Fill all fields');

                db.add(DB_KEYS.ORDERS, { customer: cust, branch, details, agentId: app.currentUser.id, status: 'Pending' });
                app.toast('Order Placed', 'success');
                app.renderAgent();
            },

            updateStatus: (key, id, status) => {
                db.update(key, id, { status });
                if(app.currentUser.role === 'manager') app.renderManager();
                else app.renderAgent();
                app.toast('Status Updated', 'success');
            }
        };

        // Initialize
        window.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>
